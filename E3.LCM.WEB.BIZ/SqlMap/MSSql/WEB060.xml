<?xml version="1.0" encoding="euc-kr" ?>
<sqlMap namespace="E3.COM.SYS.BIZ" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

	<statements>
		<select id="WEB060_SELECT">
			<![CDATA[
			SELECT DISTINCT 
					A.PLANT_ID
					,EMP.EMP_ID
					,STRING_AGG(CD1.CODE_NAME, ',') WITHIN GROUP(ORDER BY D.CMP_NM) PLANT_NM					
					,STRING_AGG(CD2.CODE_NAME, ',') WITHIN GROUP(ORDER BY D.CMP_NM) FACT_NM					
					,STRING_AGG(CD3.CODE_NAME, ',') WITHIN GROUP(ORDER BY D.CMP_NM) TA_CODE_NM
					,STRING_AGG(D.CMP_NM, '/') CMP_NM
					,STRING_AGG(A.TA_SUB, '/') TA_SUB
					,A.EMP_NM
					,B.FILE_NAME
					,B.FILE_TYPE
					,C.FILE_APPR_YN 
					,ISNULL(CD4.CODE_NAME, '미제출') FILE_APPR_YN_NM					
					,EMP.EMP_TEL_NO
					,DBO.FN_MASK_TELNO(EMP.EMP_TEL_NO) EMP_TEL_NO_MSK									
					,CASE WHEN ISNULL (EMP.FILE_SMS_SEND, '')  = '' THEN 'N' ELSE 'Y' END FILE_SMS_SEND_YN
					,EMP.FILE_SMS_SEND	FILE_SMS_SEND_DT
					,C.REG_DT
					,C.FILE_ID
					,CASE WHEN ISNULL(C.READ_YN, 'N') = 'N' THEN '1'
						  WHEN ISNULL(C.READ_YN, 'N') = 'Y' THEN '3' END  READ_YN
					,CASE WHEN ISNULL(C.READ_YN, 'N') = 'N' THEN '미확인'
						  WHEN ISNULL(C.READ_YN, 'N') = 'Y' THEN '확인' END  READ_YN_NM
			FROM SE_TA_EMP_EXCEL A
			INNER JOIN SE_TA_EMP EMP ON EMP.PLANT_ID = A.PLANT_ID AND A.EMP_ID = EMP.EMP_ID
			INNER JOIN SE_TA_ATTC_DOC_MAN B ON A.PLANT_ID = B.PLANT_ID AND A.TA_CODE = B.TA_ID AND EMP.ACCESS_GB = B.ACCP_GB
			INNER JOIN SE_TA_ATTC_FILE C ON A.PLANT_ID = C.PLANT_ID AND A.EMP_ID = C.EMP_ID AND B.FILE_TYPE = C.FILE_TYPE
			LEFT OUTER JOIN SE_TA_CMP D ON A.CMP_ID = D.CMP_ID
			LEFT OUTER JOIN E3_CODE CD1 ON A.PLANT_ID = CD1.CODE_ID AND CD1.PARENT_ID = 'PLANTID'
			LEFT OUTER JOIN E3_CODE CD2 ON A.FACT_CD = CD2.CODE_ID AND CD2.PARENT_ID = 'FACT_CD'
			LEFT OUTER JOIN E3_CODE CD3 ON A.TA_CODE = CD3.CODE_ID AND CD3.PARENT_ID = 'TA_MNG'
			LEFT OUTER JOIN E3_CODE CD4 ON C.FILE_APPR_YN = CD4.CODE_ID AND CD4.PARENT_ID = 'FILE_STATE'
			WHERE 1 = 1
			
			]]>
			<isNotNull property="PLANT_ID">
				<isNotEmpty property="PLANT_ID">
					<![CDATA[
				AND A.PLANT_ID = #PLANT_ID#
				]]>
				</isNotEmpty>
			</isNotNull>

			<isNotNull property="TA_CD">
				<isNotEmpty property="TA_CD">
					<![CDATA[
				AND A.TA_CODE = #TA_CD#
				]]>
				</isNotEmpty>
			</isNotNull>

			<isNotNull property="SUB_TA_NM">
				<isNotEmpty property="SUB_TA_NM">
					<![CDATA[
				AND A.TA_SUB LIKE '%' + #SUB_TA_NM# + '%'
				]]>
				</isNotEmpty>
			</isNotNull>

			<isNotNull property="CMP_NM">
				<isNotEmpty property="CMP_NM">
					<![CDATA[
				AND C.CMP_NM LIKE '%' + #CMP_NM# + '%'
				]]>
				</isNotEmpty>
			</isNotNull>

			<isNotNull property="EMP_NM">
				<isNotEmpty property="EMP_NM">
					<![CDATA[
				AND A.EMP_NM LIKE '%' + #EMP_NM# + '%'
				]]>
				</isNotEmpty>
			</isNotNull>
			GROUP BY  A.PLANT_ID ,A.EMP_NM, EMP.EMP_ID
			,B.FILE_NAME,B.FILE_TYPE,C.FILE_APPR_YN, EMP.EMP_TEL_NO
			,EMP.FILE_SMS_SEND,CD4.CODE_NAME, C.REG_DT, C.FILE_ID
			,C.READ_YN
			ORDER BY C.REG_DT desc, C.FILE_APPR_YN, C.FILE_ID
		</select>

		<select id="WEB060_SELECT_EMP_DTL">
			<![CDATA[
			SELECT 
			    C.CODE_NAME PLANT_NM
			  , D.CODE_NAME FACT_NM
			  , E.CODE_NAME TA_NM
			  , A.PLANT_ID
			  , A.TA_CODE
			  , A.TA_SUB
			  , A.EMP_NM			  
			  , DBO.FN_MASK_TELNO2(A.EMP_TEL_NO) EMP_TEL_NO
			  , A.CMP_ID
			  , CMP.CMP_NM
			  , B.RMK
			  , CONVERT(CHAR(19), B.PRIVACY_CONSENT_DT, 20) PRIVACY_CONSENT_DT
			  , CONVERT(CHAR(19), B.SAFE_EDU_CMPLT_DT, 20) SAFE_EDU_CMPLT_DT
			  , CONVERT(CHAR(19), B.PASS_DT, 20) PASS_DT
			  , B.ID_PHOTO
			  , CMP.MNGR_TEL_NO
			  , B.BP_HIGHT
			  , B.BP_LOW
			  , F.CODE_NAME ACCESS_GB_NM
			  , ISNULL(B.ACCESS_POSSIBLE_YN , 'APPR_N') ACCESS_POSSIBLE_YN
			  , B.ACCESS_POSSIBLE_DT 
			  , A.UPLOAD_SEQ
			  , A.EMP_ID
			  , B.ADDR
			  , CASE WHEN ISNULL(B.BIRTH_DT, '') = '' THEN NULL ELSE left(REPLACE(B.BIRTH_DT, '.', ''),4)+'.'+substring(REPLACE(B.BIRTH_DT, '.', ''),5,2)+'.'+substring(REPLACE(B.BIRTH_DT, '.', ''),7,2) END BIRTH_DT
			  , B.CRTIC_NO
			FROM SE_TA_EMP_EXCEL A
			INNER JOIN SE_TA_EMP B ON A.EMP_ID = B.EMP_ID AND A.PLANT_ID = B.PLANT_ID
			LEFT OUTER JOIN SE_TA_CMP CMP ON A.CMP_ID = CMP.CMP_ID
			LEFT OUTER JOIN E3_CODE C ON A.PLANT_ID = C.CODE_ID
			LEFT OUTER JOIN E3_CODE D ON A.FACT_CD = D.CODE_ID
			LEFT OUTER JOIN E3_CODE E ON A.TA_CODE = E.CODE_ID
			LEFT OUTER JOIN E3_CODE F ON A.ACCESS_GB = F.CODE_ID
			WHERE A.EMP_ID = #EMP_ID#
			]]>
		</select>

		<select id="WEB060_SELECT_EMP_FILE">
			<![CDATA[
			WITH EMP_FILE_LIST AS (
				SELECT 
					E.PLANT_ID, E.EMP_ID, E.ACCESS_GB, M.FILE_TYPE, M.FILE_NAME 
				FROM SE_TA_EMP E
				INNER JOIN SE_TA_ATTC_DOC_MAN M ON E.ACCESS_GB = M.ACCP_GB
			)
			SELECT 
				 A.FILE_TYPE
				,D.CODE_NAME FILE_TYPE_NM
				,B.REAL_FILE_NM REAL_FILE_NM
				,B.FILE_APPR_DT			
				,ISNULL(E.CODE_NAME, '미제출') FILE_APPR_YN_NM				
				,CASE WHEN ISNULL (C.FILE_SMS_SEND, '')  = '' THEN 'N' ELSE 'Y' END FILE_SMS_SEND_YN				
				,CONVERT(CHAR(19), C.FILE_SMS_SEND, 20) FILE_SMS_SEND_DT
				,B.FILE_ID
				,NULL UPLOAD_FILE 
				,ISNULL(B.FILE_APPR_YN, 'FILE_STATE_1') ORG_FILE_APPR_YN
				,CASE WHEN ISNULL(B.READ_YN, 'N') = 'N' THEN '1'
					  WHEN ISNULL(B.READ_YN, 'N') = 'Y' THEN '3' END  READ_YN
				,CASE WHEN ISNULL(B.READ_YN, 'N') = 'N' THEN '미확인'
					  WHEN ISNULL(B.READ_YN, 'N') = 'Y' THEN '확인' END  READ_YN_NM
			FROM EMP_FILE_LIST A
			INNER JOIN SE_TA_EMP C ON A.PLANT_ID = C.PLANT_ID AND A.EMP_ID = C.EMP_ID
			LEFT OUTER JOIN SE_TA_ATTC_FILE B ON A.PLANT_ID = B.PLANT_ID AND A.EMP_ID = B.EMP_ID AND A.FILE_TYPE = B.FILE_TYPE			
			LEFT OUTER JOIN E3_CODE D ON A.FILE_TYPE = D.CODE_ID
			LEFT OUTER JOIN E3_CODE E ON B.FILE_APPR_YN = E.CODE_ID
			WHERE A.EMP_ID = #EMP_ID#

			]]>
		</select>
		
		
	</statements>
</sqlMap>