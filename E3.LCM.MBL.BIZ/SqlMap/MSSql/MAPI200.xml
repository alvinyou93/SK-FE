<?xml version="1.0" encoding="euc-kr" ?>
<sqlMap namespace="E3.LCM.MBL.BIZ" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>
    <select id="MAPI200_SELECT_SIGN_SHEET">
		<![CDATA[
				WITH FACT_KND AS 
				(
					SELECT CODE_ID AS ID, CODE_NAME AS NME FROM E3_CODE WHERE PARENT_ID = 'FACT_KND' AND USE_YN = 'Y'
				),
				JOB_KND AS
				(
					SELECT CODE_ID AS ID, CODE_NAME AS NME FROM E3_CODE WHERE PARENT_ID = 'JOB_KND' AND USE_YN = 'Y'
				),
				WK_STATUS AS
				(
					SELECT CODE_ID AS ID, CODE_NAME AS NME FROM E3_CODE WHERE PARENT_ID = 'WK_STATUS' AND USE_YN = 'Y'
				),
				JOB_AUTH AS
				(
					SELECT R1.PLANT_ID, R1.JOB_ID, R1.AUTHORITY_ID
					FROM WK_JOB_AUTH_MAPPING R1 LEFT OUTER JOIN E3_USER_AUTH_MAPPING R2 ON R1.AUTHORITY_ID = R2.AUTHORITY_ID
					WHERE R2.USER_ID = #USER_ID#
				),
				JOB_MASTER AS (
					SELECT T1.PLANT_ID, T1.TA_ID, T1.FACILITY_KND
						,(SELECT CODE_NAME FROM E3_CODE WHERE CODE_ID = T1.FACILITY_KND AND USE_YN = 'Y') FACILITY_KND_NM
						, T1.PROCESS_CD, T1.FACILITY_NO, T1.FACILITY_NM, T1.RMK
            
						, T2.STEP1_CD
						, S1.COMP_DT AS STEP1_COMP_DT, S1.MNGR_ID AS STEP1_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S1.MNGR_ID AND USE_YN = 'Y') AS STEP1_MNGR_NM
						, CASE WHEN S1.WK_STATUS IS NULL THEN 'WN' ELSE S1.WK_STATUS END STEP1_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S1.STEP_CD, T2.STEP1_CD)) THEN 'Y' ELSE 'N' END AS STEP1_AUTH
            
						, T2.STEP2_CD
						, S2.COMP_DT AS STEP2_COMP_DT, S2.MNGR_ID AS STEP2_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S2.MNGR_ID AND USE_YN = 'Y') AS STEP2_MNGR_NM
						, CASE WHEN S1.STEP_CD IS NOT NULL THEN ISNULL(S2.WK_STATUS, 'WN') ELSE '' END STEP2_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S2.STEP_CD, T2.STEP2_CD)) THEN 'Y' ELSE 'N' END AS STEP2_AUTH

						, T2.STEP3_CD
						, S3.COMP_DT AS STEP3_COMP_DT, S3.MNGR_ID AS STEP3_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S3.MNGR_ID AND USE_YN = 'Y') AS STEP3_MNGR_NM
						, CASE WHEN S2.STEP_CD IS NOT NULL THEN ISNULL(S3.WK_STATUS, 'WN') ELSE '' END STEP3_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S3.STEP_CD, T2.STEP3_CD)) THEN 'Y' ELSE 'N' END AS STEP3_AUTH

						, T2.STEP4_CD
						, S4.COMP_DT AS STEP4_COMP_DT, S4.MNGR_ID AS STEP4_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S4.MNGR_ID AND USE_YN = 'Y') AS STEP4_MNGR_NM
						, CASE WHEN S3.STEP_CD IS NOT NULL THEN ISNULL(S4.WK_STATUS, 'WN') ELSE '' END STEP4_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S4.STEP_CD, T2.STEP4_CD)) THEN 'Y' ELSE 'N' END AS STEP4_AUTH

						, T2.STEP5_CD
						, S5.COMP_DT AS STEP5_COMP_DT, S5.MNGR_ID AS STEP5_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S5.MNGR_ID AND USE_YN = 'Y') AS STEP5_MNGR_NM
						, CASE WHEN S4.STEP_CD IS NOT NULL THEN ISNULL(S5.WK_STATUS, 'WN') ELSE '' END STEP5_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S5.STEP_CD, T2.STEP5_CD)) THEN 'Y' ELSE 'N' END AS STEP5_AUTH

						, T2.STEP6_CD
						, S6.COMP_DT AS STEP6_COMP_DT, S6.MNGR_ID AS STEP6_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S6.MNGR_ID AND USE_YN = 'Y') AS STEP6_MNGR_NM
						, CASE WHEN S5.STEP_CD IS NOT NULL THEN ISNULL(S6.WK_STATUS, 'WN') ELSE '' END STEP6_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S6.STEP_CD, T2.STEP6_CD)) THEN 'Y' ELSE 'N' END AS STEP6_AUTH

						, T2.STEP7_CD
						, S7.COMP_DT AS STEP7_COMP_DT, S7.MNGR_ID AS STEP7_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S7.MNGR_ID AND USE_YN = 'Y') AS STEP7_MNGR_NM
						, CASE WHEN S6.STEP_CD IS NOT NULL THEN ISNULL(S7.WK_STATUS, 'WN') ELSE '' END STEP7_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S7.STEP_CD, T2.STEP7_CD)) THEN 'Y' ELSE 'N' END AS STEP7_AUTH

						, T2.STEP8_CD
						, S8.COMP_DT AS STEP8_COMP_DT, S8.MNGR_ID AS STEP8_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S8.MNGR_ID AND USE_YN = 'Y') AS STEP8_MNGR_NM
						, CASE WHEN S7.STEP_CD IS NOT NULL THEN ISNULL(S8.WK_STATUS, 'WN') ELSE '' END STEP8_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S8.STEP_CD, T2.STEP8_CD)) THEN 'Y' ELSE 'N' END AS STEP8_AUTH

						, T2.STEP9_CD
						, S9.COMP_DT AS STEP9_COMP_DT, S9.MNGR_ID AS STEP9_MNGR_ID
						, (SELECT USER_NAME FROM E3_USER WHERE USER_ID = S9.MNGR_ID AND USE_YN = 'Y') AS STEP9_MNGR_NM
						, CASE WHEN S8.STEP_CD IS NOT NULL THEN ISNULL(S9.WK_STATUS, 'WN') ELSE '' END STEP9_STATUS
						, CASE WHEN EXISTS (SELECT 1 FROM JOB_AUTH WHERE JOB_ID = ISNULL(S9.STEP_CD, T2.STEP9_CD)) THEN 'Y' ELSE 'N' END AS STEP9_AUTH
					FROM WK_FACILITY_INFO T1 
						LEFT OUTER JOIN WK_FACILITY_STEP T2 ON T1.PLANT_ID = T2.PLANT_ID AND T1.TA_ID = T2.TA_ID AND T1.FACILITY_KND = T2.FACILITY_KND
						LEFT OUTER JOIN WK_SIGN_SHEET S1 ON T1.PLANT_ID = S1.PLANT_ID AND T1.TA_ID = S1.TA_ID AND T1.FACILITY_KND = S1.FACILITY_KND AND T1.PROCESS_CD = S1.PROCESS_CD AND T1.FACILITY_NO = S1.FACILITY_NO AND T2.STEP1_CD = S1.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S2 ON T1.PLANT_ID = S2.PLANT_ID AND T1.TA_ID = S2.TA_ID AND T1.FACILITY_KND = S2.FACILITY_KND AND T1.PROCESS_CD = S2.PROCESS_CD AND T1.FACILITY_NO = S2.FACILITY_NO AND T2.STEP2_CD = S2.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S3 ON T1.PLANT_ID = S3.PLANT_ID AND T1.TA_ID = S3.TA_ID AND T1.FACILITY_KND = S3.FACILITY_KND AND T1.PROCESS_CD = S3.PROCESS_CD AND T1.FACILITY_NO = S3.FACILITY_NO AND T2.STEP3_CD = S3.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S4 ON T1.PLANT_ID = S4.PLANT_ID AND T1.TA_ID = S4.TA_ID AND T1.FACILITY_KND = S4.FACILITY_KND AND T1.PROCESS_CD = S4.PROCESS_CD AND T1.FACILITY_NO = S4.FACILITY_NO AND T2.STEP4_CD = S4.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S5 ON T1.PLANT_ID = S5.PLANT_ID AND T1.TA_ID = S5.TA_ID AND T1.FACILITY_KND = S5.FACILITY_KND AND T1.PROCESS_CD = S5.PROCESS_CD AND T1.FACILITY_NO = S5.FACILITY_NO AND T2.STEP5_CD = S5.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S6 ON T1.PLANT_ID = S6.PLANT_ID AND T1.TA_ID = S6.TA_ID AND T1.FACILITY_KND = S6.FACILITY_KND AND T1.PROCESS_CD = S6.PROCESS_CD AND T1.FACILITY_NO = S6.FACILITY_NO AND T2.STEP6_CD = S6.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S7 ON T1.PLANT_ID = S7.PLANT_ID AND T1.TA_ID = S7.TA_ID AND T1.FACILITY_KND = S7.FACILITY_KND AND T1.PROCESS_CD = S7.PROCESS_CD AND T1.FACILITY_NO = S7.FACILITY_NO AND T2.STEP7_CD = S7.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S8 ON T1.PLANT_ID = S8.PLANT_ID AND T1.TA_ID = S8.TA_ID AND T1.FACILITY_KND = S8.FACILITY_KND AND T1.PROCESS_CD = S8.PROCESS_CD AND T1.FACILITY_NO = S8.FACILITY_NO AND T2.STEP8_CD = S8.STEP_CD
						LEFT OUTER JOIN WK_SIGN_SHEET S9 ON T1.PLANT_ID = S9.PLANT_ID AND T1.TA_ID = S9.TA_ID AND T1.FACILITY_KND = S9.FACILITY_KND AND T1.PROCESS_CD = S9.PROCESS_CD AND T1.FACILITY_NO = S9.FACILITY_NO AND T2.STEP9_CD = S9.STEP_CD
					WHERE 1=1
		]]>
          <isNotNull property="PLANT_ID">
            <isNotEmpty property="PLANT_ID">
              AND T1.PLANT_ID = #PLANT_ID#
            </isNotEmpty>
          </isNotNull>
          <isNotNull property="TA_ID">
            <isNotEmpty property="TA_ID">
              AND T1.TA_ID = #TA_ID#
            </isNotEmpty>
          </isNotNull>
          <isNotNull property="FACILITY_KND">
            <isNotEmpty property="FACILITY_KND">
              AND T1.FACILITY_KND = #FACILITY_KND#
            </isNotEmpty>
          </isNotNull>
          <isNotNull property="PROCESS_CD">
            <isNotEmpty property="PROCESS_CD">
              AND T1.PROCESS_CD = #PROCESS_CD#
            </isNotEmpty>
          </isNotNull>
          <isNotNull property="FACILITY_NO">
            <isNotEmpty property="FACILITY_NO">
              AND T1.FACILITY_NO LIKE '%' + #FACILITY_NO# + '%'
            </isNotEmpty>
          </isNotNull>
          <isNotNull property="FACILITY_NM">
            <isNotEmpty property="FACILITY_NM">
              AND CONCAT(T1.FACILITY_NO, T1.FACILITY_NM) LIKE '%' + #FACILITY_NM# + '%'
            </isNotEmpty>
          </isNotNull>
		<![CDATA[
				)
				SELECT PLANT_ID, TA_ID, FACILITY_KND, FACILITY_KND_NM, PROCESS_CD, FACILITY_NO, FACILITY_NM, RMK
						, STEP1_CD, STEP1_NM, STEP1_STATUS_NM, STEP1_AUTH
						, STEP2_CD, STEP2_NM, STEP2_STATUS_NM, STEP2_AUTH
						, STEP3_CD, STEP3_NM, STEP3_STATUS_NM, STEP3_AUTH
						, STEP4_CD, STEP4_NM, STEP4_STATUS_NM, STEP4_AUTH
						, STEP5_CD, STEP5_NM, STEP5_STATUS_NM, STEP5_AUTH
						, STEP6_CD, STEP6_NM, STEP6_STATUS_NM, STEP6_AUTH
						, STEP7_CD, STEP7_NM, STEP7_STATUS_NM, STEP7_AUTH
						, STEP8_CD, STEP8_NM, STEP8_STATUS_NM, STEP8_AUTH
						, STEP9_CD, STEP9_NM, STEP9_STATUS_NM, STEP9_AUTH
						, ROW_STATE, ING_STEP
						, (CASE LEN(ISNULL(STEP1_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END + CASE LEN(ISNULL(STEP2_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END +
							CASE LEN(ISNULL(STEP3_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END + CASE LEN(ISNULL(STEP4_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END +
							CASE LEN(ISNULL(STEP5_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END + CASE LEN(ISNULL(STEP6_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END +
							CASE LEN(ISNULL(STEP7_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END + CASE LEN(ISNULL(STEP8_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END +
							CASE LEN(ISNULL(STEP9_STATUS_NM, '')) WHEN 0 THEN 0 ELSE 1 END ) CUR_STEP
				FROM (
					SELECT MA.PLANT_ID
							,MA.TA_ID
							,MA.FACILITY_KND, (SELECT NME FROM FACT_KND WHERE ID = MA.FACILITY_KND) FACILITY_KND_NM
							,MA.PROCESS_CD
							,MA.FACILITY_NO
							,MA.FACILITY_NM
							,MA.RMK
							,MA.STEP1_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP1_CD) STEP1_NM
							,MA.STEP1_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP1_STATUS) + ' ' + MA.STEP1_COMP_DT + ' ' + MA.STEP1_MNGR_NM AS STEP1_STATUS_NM 
							,MA.STEP1_AUTH

							,MA.STEP2_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP2_CD) STEP2_NM
							,MA.STEP2_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP2_STATUS) + ' ' + MA.STEP2_COMP_DT + ' ' + MA.STEP2_MNGR_NM AS STEP2_STATUS_NM 
							,MA.STEP2_AUTH

							,MA.STEP3_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP3_CD) STEP3_NM
							,MA.STEP3_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP3_STATUS) + ' ' + MA.STEP3_COMP_DT + ' ' + MA.STEP3_MNGR_NM AS STEP3_STATUS_NM 
							,MA.STEP3_AUTH

							,MA.STEP4_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP4_CD) STEP4_NM
							,MA.STEP4_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP4_STATUS) + ' ' + MA.STEP4_COMP_DT + ' ' + MA.STEP4_MNGR_NM AS STEP4_STATUS_NM 
							,MA.STEP4_AUTH

							,MA.STEP5_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP5_CD) STEP5_NM
							,MA.STEP5_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP5_STATUS) + ' ' + MA.STEP5_COMP_DT + ' ' + MA.STEP5_MNGR_NM AS STEP5_STATUS_NM 
							,MA.STEP5_AUTH

							,MA.STEP6_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP6_CD) STEP6_NM
							,MA.STEP6_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP6_STATUS) + ' ' + MA.STEP6_COMP_DT + ' ' + MA.STEP6_MNGR_NM AS STEP6_STATUS_NM 
							,MA.STEP6_AUTH

							,MA.STEP7_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP7_CD) STEP7_NM
							,MA.STEP7_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP7_STATUS) + ' ' + MA.STEP7_COMP_DT + ' ' + MA.STEP7_MNGR_NM AS STEP7_STATUS_NM 
							,MA.STEP7_AUTH

							,MA.STEP8_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP8_CD) STEP8_NM
							,MA.STEP8_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP8_STATUS) + ' ' + MA.STEP8_COMP_DT + ' ' + MA.STEP8_MNGR_NM AS STEP8_STATUS_NM 
							,MA.STEP8_AUTH

							,MA.STEP9_CD, (SELECT NME FROM JOB_KND WHERE ID = MA.STEP9_CD) STEP9_NM
							,MA.STEP9_STATUS, (SELECT NME FROM WK_STATUS WHERE ID = MA.STEP9_STATUS) + ' ' + MA.STEP9_COMP_DT + ' ' + MA.STEP9_MNGR_NM AS STEP9_STATUS_NM 
							,MA.STEP9_AUTH

							,'N' AS ROW_STATE
							,LEN(CONCAT(STEP1_CD, STEP2_CD, STEP3_CD, STEP4_CD, STEP5_CD, STEP6_CD, STEP7_CD, STEP8_CD, STEP9_CD)) / 5  AS ING_STEP
					FROM JOB_MASTER MA
				) JOB
				ORDER BY PLANT_ID, TA_ID, FACILITY_KND, PROCESS_CD, FACILITY_NO
		]]>
    </select>

    <insert id="MAPI200_INSERT_SIGN_SHEET">
		<![CDATA[
				INSERT INTO WK_SIGN_SHEET
				(
						PLANT_ID    /*사업장ID*/
					, TA_ID    /*TA ID*/
					, FACILITY_KND    /*설비종류*/
					, PROCESS_CD    /*공정*/
					, FACILITY_NO    /*설비번호*/
					, STEP_CD    /*단계*/
					, WK_STATUS    /*작업상태*/
					, MNGR_ID    /*담당자ID*/
					, COMP_DT    /*완료일자*/
					, RMK    /*비고*/
					, REG_ID    /*등록자ID*/
					, REG_DATE    /*등록일자*/
				) 
				VALUES 
				(
					#PLANT_ID#, #TA_ID#, #FACILITY_KND#, #PROCESS_CD#, #FACILITY_NO#, #STEP_CD#, #WK_STATUS#
          , #LOGINID#, CONVERT(VARCHAR(8),GETDATE(),112), #RMK#, #LOGINID#, GETDATE()
				)   
		]]>
    </insert>
    
  </statements>
</sqlMap>